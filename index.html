<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D&D 5e - Groupe En Ligne (Europe)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { background-color: #020617; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        .loading-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(2,6,23,0.9); z-index:9999; display:flex; justify-content:center; align-items:center; color:white; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, remove, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDiLZ6-l8a_rrXUMBYNXPql0TRcN46IAqo",
            authDomain: "dnd-character-sheets-c0bd5.firebaseapp.com",
            databaseURL: "https://dnd-character-sheets-c0bd5-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "dnd-character-sheets-c0bd5",
            storageBucket: "dnd-character-sheets-c0bd5.firebasestorage.app",
            messagingSenderId: "731039801856",
            appId: "1:731039801856:web:9bdb731adfda2d33beeee5"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        window.fbDB = db;
        window.fbRef = ref;
        window.fbSet = set;
        window.fbUpdate = update;
        window.fbOnValue = onValue;
        window.fbRemove = remove;
        
        console.log("Firebase connecté (Europe)");
        window.dispatchEvent(new Event('firebase-ready'));
    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- ICONES (Ajout de Eye) ---
        const IconBase = ({ size = 18, className = "", children }) => (<svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>);
        const Shield = (p) => <IconBase {...p}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></IconBase>;
        const Heart = (p) => <IconBase {...p}><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></IconBase>;
        const Zap = (p) => <IconBase {...p}><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></IconBase>;
        const Scroll = (p) => <IconBase {...p}><path d="M8 2h8a4 4 0 0 1 4 4v16H4V6a4 4 0 0 1 4-4Z"/><path d="M12 2v6"/></IconBase>;
        const Sword = (p) => <IconBase {...p}><polyline points="14.5 17.5 3 6 3 3 6 3 17.5 14.5"/><line x1="13" x2="19" y1="19" y2="13"/><line x1="16" x2="20" y1="16" y2="20"/><line x1="19" x2="21" y1="21" y2="19"/></IconBase>;
        const Dice5 = (p) => <IconBase {...p}><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><path d="M16 8h.01"/><path d="M8 8h.01"/><path d="M8 16h.01"/><path d="M16 16h.01"/><path d="M12 12h.01"/></IconBase>;
        const User = (p) => <IconBase {...p}><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></IconBase>;
        const Trash2 = (p) => <IconBase {...p}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></IconBase>;
        const Coins = (p) => <IconBase {...p}><circle cx="8" cy="8" r="6"/><path d="M18.09 10.37A6 6 0 1 1 10.34 18"/><path d="M7 6h1v4"/><path d="m16.71 13.88.7.71-2.82 2.82"/></IconBase>;
        const ChevronDown = (p) => <IconBase {...p}><path d="m6 9 6 6 6-6"/></IconBase>;
        const ChevronUp = (p) => <IconBase {...p}><path d="m18 15-6-6-6 6"/></IconBase>;
        const Plus = (p) => <IconBase {...p}><path d="M5 12h14"/><path d="M12 5v14"/></IconBase>;
        const Camera = (p) => <IconBase {...p}><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></IconBase>;
        const Download = (p) => <IconBase {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></IconBase>;
        const Upload = (p) => <IconBase {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></IconBase>;
        const Users = (p) => <IconBase {...p}><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></IconBase>;
        const Backpack = (p) => <IconBase {...p}><path d="M4 10a4 4 0 0 1 4-4h8a4 4 0 0 1 4 4v10a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2Z"/><path d="M9 6V4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2"/><path d="M8 21v-5a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v5"/><path d="M8 10h8"/><path d="M9 21v-5a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v5"/></IconBase>;
        const MessageSquare = (p) => <IconBase {...p}><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></IconBase>;
        const AlertTriangle = (p) => <IconBase {...p}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></IconBase>;
        const Wifi = (p) => <IconBase {...p}><path d="M5 12.55a11 11 0 0 1 14.08 0"/><path d="M1.42 9a16 16 0 0 1 21.16 0"/><path d="M8.53 16.11a6 6 0 0 1 6.95 0"/><line x1="12" y1="20" x2="12.01" y2="20"/></IconBase>;
        const Eye = (p) => <IconBase {...p}><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></IconBase>;

        const getModifier = (s) => Math.floor((s - 10) / 2);
        const getProficiencyBonus = (l) => Math.ceil(l / 4) + 1;
        const formatMod = (m) => (m >= 0 ? `+${m}` : m);

        const SortControls = ({ index, total, onMove }) => (
            <div className="flex flex-col gap-0.5 mx-1 print:hidden">
                <button onClick={() => onMove(index, -1)} disabled={index === 0} className={`text-slate-500 hover:text-amber-400 p-0.5 rounded ${index === 0 ? 'opacity-20 cursor-default' : ''}`}><ChevronUp size={12} /></button>
                <button onClick={() => onMove(index, 1)} disabled={index === total - 1} className={`text-slate-500 hover:text-amber-400 p-0.5 rounded ${index === total - 1 ? 'opacity-20 cursor-default' : ''}`}><ChevronDown size={12} /></button>
            </div>
        );

        class ErrorBoundary extends React.Component {
            constructor(props) { super(props); this.state = { hasError: false }; }
            static getDerivedStateFromError(error) { return { hasError: true }; }
            componentDidCatch(error, errorInfo) { console.error("Crash:", error, errorInfo); }
            render() {
                if (this.state.hasError) return (
                    <div className="flex flex-col items-center justify-center h-64 text-red-400 gap-4 bg-slate-900 m-8 rounded border border-red-900">
                        <AlertTriangle size={48} /><h2>Erreur de chargement</h2>
                        <button onClick={() => window.location.reload()} className="bg-red-600 text-white px-4 py-2 rounded">Recharger</button>
                    </div>
                );
                return this.props.children;
            }
        }

        const FeatureRow = ({ feature, index, updateChar, featuresList, moveFeature }) => {
            const [expanded, setExpanded] = useState(false);
            const isLong = feature.description.length > 60;
            const update = (f, v) => { const n = [...featuresList]; n[index][f] = v; updateChar('features', n); };
            return (
                <div className="bg-slate-700/30 border border-slate-700 rounded-lg p-2 mb-2 hover:bg-slate-700/50 transition-colors group flex gap-2">
                    <SortControls index={index} total={featuresList.length} onMove={moveFeature} />
                    <div className="flex-1 min-w-0">
                        <div className="flex justify-between items-start mb-1 gap-2">
                            <input className="font-bold text-amber-400 bg-transparent outline-none w-full text-sm" value={feature.name} onChange={(e) => update('name', e.target.value)} placeholder="Nom" />
                            <button onClick={() => updateChar('features', featuresList.filter((_,i)=>i!==index))} className="text-slate-600 hover:text-red-400 opacity-0 group-hover:opacity-100 transition-opacity"><Trash2 size={14} /></button>
                        </div>
                        <div className="relative">
                            <textarea className="w-full bg-transparent text-xs text-slate-300 resize-none outline-none leading-relaxed" value={feature.description} rows={expanded || !isLong ? 2 : 5} onChange={(e) => update('description', e.target.value)} placeholder="Desc..." style={{ minHeight: '2.5em' }} />
                            {isLong && !expanded && <div className="absolute bottom-0 left-0 w-full h-8 bg-gradient-to-t from-slate-800 to-transparent flex items-end justify-center cursor-pointer" onClick={() => setExpanded(true)}><ChevronDown size={14} className="text-amber-500 bg-slate-900 rounded-full" /></div>}
                            {isLong && expanded && <div className="flex justify-center mt-1 cursor-pointer" onClick={() => setExpanded(false)}><ChevronUp size={14} className="text-slate-500" /></div>}
                        </div>
                    </div>
                </div>
            );
        };

        const InventoryRow = ({ item, index, updateChar, inventoryList, moveInventory }) => {
            const update = (f, v) => { const n = [...inventoryList]; n[index][f] = v; updateChar('inventory', n); };
            return (
                <div className="flex gap-2 mb-1 items-center bg-slate-900/40 p-1.5 rounded border border-slate-700/50 hover:border-slate-600">
                     <SortControls index={index} total={inventoryList.length} onMove={moveInventory} />
                     <input className="bg-transparent text-slate-200 text-sm outline-none flex-1 placeholder-slate-600" value={item.name} onChange={(e) => update('name', e.target.value)} placeholder="Objet" />
                     <input className="bg-slate-800 text-center text-amber-400 font-mono text-sm rounded w-12 outline-none border border-slate-700 focus:border-amber-500" type="number" value={item.qty} onChange={(e) => update('qty', parseInt(e.target.value) || 1)} />
                     <button onClick={() => updateChar('inventory', inventoryList.filter((_,i)=>i!==index))} className="text-slate-600 hover:text-red-400 transition-colors"><Trash2 size={14} /></button>
                </div>
            )
        };

        const AttackRow = ({ attack, index, updateChar, attacksList, moveAttack }) => {
            const update = (f, v) => { const n = [...attacksList]; n[index][f] = v; updateChar('attacks', n); };
            return (
                <div className="bg-slate-700/50 p-2 rounded mb-2 flex flex-col md:flex-row md:items-center justify-between gap-2 border border-slate-600">
                    <div className="flex items-center gap-2 w-full md:w-auto flex-1">
                        <SortControls index={index} total={attacksList.length} onMove={moveAttack} />
                        <input className="bg-transparent text-amber-400 font-bold outline-none w-full" value={attack.name} onChange={(e) => update('name', e.target.value)} />
                    </div>
                    <div className="flex gap-2">
                        <input className="bg-slate-800 text-center text-white rounded w-12 text-sm p-1" placeholder="Atq" value={attack.bonus} onChange={(e) => update('bonus', e.target.value)} />
                        <input className="bg-slate-800 text-white rounded w-full md:w-32 text-sm p-1" placeholder="Dégâts" value={attack.damage} onChange={(e) => update('damage', e.target.value)} />
                        <button className="text-red-400 hover:text-red-300 p-1" onClick={() => updateChar('attacks', attacksList.filter((_,i)=>i!==index))}><Trash2 size={16} /></button>
                    </div>
                </div>
            );
        };

        // --- COMPOSANT FICHE CONNECTÉE ---
        const CharacterSheet = ({ characterId, updateProfileName }) => {
            const initialCharacter = {
                name: "Nouveau Personnage", class: "Classe", level: 1, species: "Espèce", background: "Historique", alignment: "",
                xp: 0, heroicInspiration: false, image: null, 
                stats: { str: 10, dex: 10, con: 10, int: 10, wis: 10, cha: 10 },
                hp: { current: 10, max: 10, temp: 0 }, ac: 10, speed: 30, initiativeBonus: 0,
                skills: {}, saves: {}, coins: { cp: 0, sp: 0, gp: 0, pp: 0 },
                attacks: [ { id: 1, name: "Attaque de base", bonus: "+2", damage: "1d6" } ],
                features: [], languages: "", inventory: [], notes: ""
            };

            const [char, setChar] = useState(null);
            const fileInputRef = useRef(null);
            const importInputRef = useRef(null);
            const isLocalUpdate = useRef(false);

            useEffect(() => {
                if (!window.fbDB) return;
                const charRef = window.fbRef(window.fbDB, `dnd_app/chars/${characterId}`);
                const unsubscribe = window.fbOnValue(charRef, (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        if (!isLocalUpdate.current) {
                            const safeChar = { 
                                ...initialCharacter, ...data,
                                stats: { ...initialCharacter.stats, ...(data.stats || {}) },
                                hp: { ...initialCharacter.hp, ...(data.hp || {}) },
                                coins: { ...initialCharacter.coins, ...(data.coins || {}) },
                                skills: { ...initialCharacter.skills, ...(data.skills || {}) },
                                saves: { ...initialCharacter.saves, ...(data.saves || {}) },
                                attacks: Array.isArray(data.attacks) ? data.attacks : [],
                                features: Array.isArray(data.features) ? data.features : [],
                                inventory: Array.isArray(data.inventory) ? data.inventory : [],
                            };
                            setChar(safeChar);
                        }
                        isLocalUpdate.current = false;
                    } else {
                        window.fbSet(charRef, initialCharacter);
                        setChar(initialCharacter);
                    }
                });
                return () => unsubscribe();
            }, [characterId]);

            const updateChar = (path, value) => {
                setChar(prev => {
                    const newData = { ...prev };
                    const keys = path.split('.');
                    let current = newData;
                    for (let i = 0; i < keys.length - 1; i++) current = current[keys[i]];
                    current[keys[keys.length - 1]] = value;
                    
                    isLocalUpdate.current = true;
                    window.fbSet(window.fbRef(window.fbDB, `dnd_app/chars/${characterId}`), newData);

                    if (path === 'name') {
                        updateProfileName(characterId, value);
                    }

                    return newData;
                });
            };

            const moveItem = (listKey, index, direction) => {
                setChar(prev => {
                    const list = [...prev[listKey]];
                    if (direction === -1 && index > 0) [list[index], list[index-1]] = [list[index-1], list[index]];
                    else if (direction === 1 && index < list.length -1) [list[index], list[index+1]] = [list[index+1], list[index]];
                    const newData = { ...prev, [listKey]: list };
                    isLocalUpdate.current = true;
                    window.fbSet(window.fbRef(window.fbDB, `dnd_app/chars/${characterId}`), newData);
                    return newData;
                });
            };

            const exportData = () => {
                const blob = new Blob([JSON.stringify(char, null, 2)], { type: "application/json" });
                const a = document.createElement("a");
                a.href = URL.createObjectURL(blob); a.download = `${char.name.replace(/[^a-z0-9]/gi, '_')}.json`;
                document.body.appendChild(a); a.click(); document.body.removeChild(a);
            };

            const importData = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (ev) => {
                    try { 
                        const imported = JSON.parse(ev.target.result);
                        const merged = { ...initialCharacter, ...imported };
                        setChar(merged);
                        isLocalUpdate.current = true;
                        window.fbSet(window.fbRef(window.fbDB, `dnd_app/chars/${characterId}`), merged);
                        updateProfileName(characterId, merged.name);
                    } catch (err) { alert("Erreur fichier JSON"); }
                };
                reader.readAsText(file);
            };

            if (!char) return <div className="text-slate-500 p-10 text-center animate-pulse flex flex-col items-center gap-2"><Wifi className="animate-bounce"/> Connexion au grimoire...</div>;

            const profBonus = getProficiencyBonus(char.level);
            // CALCUL DE LA PERCEPTION PASSIVE
            const wisMod = getModifier(char.stats.wis);
            const perceptionSkill = char.skills.perception; // undefined, true, 'expert'
            const passivePerception = 10 + wisMod + (perceptionSkill === true ? profBonus : perceptionSkill === 'expert' ? profBonus * 2 : 0);

            const statsConfig = [{key:'str',label:'Force'},{key:'dex',label:'Dextérité'},{key:'con',label:'Constitution'},{key:'int',label:'Intelligence'},{key:'wis',label:'Sagesse'},{key:'cha',label:'Charisme'}];
            const skillsList = [ {key:'acrobatics',label:'Acrobaties',stat:'dex'},{key:'animal_handling',label:'Dressage',stat:'wis'},{key:'arcana',label:'Arcanes',stat:'int'},{key:'athletics',label:'Athlétisme',stat:'str'},{key:'deception',label:'Tromperie',stat:'cha'},{key:'history',label:'Histoire',stat:'int'},{key:'insight',label:'Intuition',stat:'wis'},{key:'intimidation',label:'Intimidation',stat:'cha'},{key:'investigation',label:'Investigation',stat:'int'},{key:'medicine',label:'Médecine',stat:'wis'},{key:'nature',label:'Nature',stat:'int'},{key:'perception',label:'Perception',stat:'wis'},{key:'performance',label:'Représentation',stat:'cha'},{key:'persuasion',label:'Persuasion',stat:'cha'},{key:'religion',label:'Religion',stat:'int'},{key:'sleight_of_hand',label:'Escamotage',stat:'dex'},{key:'stealth',label:'Discrétion',stat:'dex'},{key:'survival',label:'Survie',stat:'wis'} ];

            return (
                <div className="animate-in fade-in duration-300">
                    <header className="bg-slate-900 border-b border-slate-800 p-4 sticky top-0 z-50 shadow-lg">
                        <div className="max-w-6xl mx-auto flex flex-col md:flex-row md:items-center gap-4">
                            <div className="relative group shrink-0 w-24 h-24 md:w-28 md:h-28 rounded-full bg-slate-800 border-2 border-slate-700 overflow-hidden cursor-pointer hover:border-amber-500 transition-colors" onClick={() => fileInputRef.current.click()}>
                                {char.image ? <img src={char.image} className="w-full h-full object-cover" /> : <div className="w-full h-full flex flex-col items-center justify-center text-slate-600 group-hover:text-amber-500/50"><User size={32} /></div>}
                                <input type="file" ref={fileInputRef} onChange={(e) => {const f=e.target.files[0]; if(f){const r=new FileReader(); r.onload=()=>updateChar('image',r.result); r.readAsDataURL(f)}}} className="hidden" accept="image/*" />
                            </div>
                            <div className="flex-1 w-full">
                                <input type="text" value={char.name} onChange={(e) => updateChar('name', e.target.value)} className="bg-transparent text-2xl md:text-3xl font-bold text-white placeholder-slate-600 w-full outline-none" />
                                <div className="flex flex-wrap gap-2 text-sm text-slate-400 mt-2 items-center">
                                    <input value={char.species} onChange={(e) => updateChar('species', e.target.value)} className="bg-slate-800/50 rounded px-2 py-0.5 outline-none hover:bg-slate-800 focus:text-amber-400 w-32" placeholder="Espèce" />
                                    <input value={char.class} onChange={(e) => updateChar('class', e.target.value)} className="bg-slate-800/50 rounded px-2 py-0.5 outline-none hover:bg-slate-800 focus:text-amber-400 w-24" placeholder="Classe" />
                                    <div className="flex items-center bg-slate-800/50 rounded px-2 py-0.5"><span className="text-slate-500 text-xs mr-1">Niv</span><input type="number" value={char.level} onChange={(e) => updateChar('level', parseInt(e.target.value) || 1)} className="bg-transparent w-8 text-center outline-none focus:text-amber-400" /></div>
                                    <input value={char.background} onChange={(e) => updateChar('background', e.target.value)} className="bg-slate-800/50 rounded px-2 py-0.5 outline-none hover:bg-slate-800 focus:text-amber-400 w-32" placeholder="Historique" />
                                    <input value={char.alignment} onChange={(e) => updateChar('alignment', e.target.value)} className="bg-slate-800/50 rounded px-2 py-0.5 outline-none hover:bg-slate-800 focus:text-amber-400 w-32" placeholder="Alignement" />
                                </div>
                            </div>
                            <div className="flex items-center gap-4 bg-slate-800 p-2 rounded-lg border border-slate-700 shrink-0">
                                <div className="text-center px-2"><div className="text-xs text-slate-400 uppercase">Maîtrise</div><div className="text-xl font-bold text-amber-400">+{profBonus}</div></div>
                                <div className="w-px h-8 bg-slate-700"></div>
                                <div className="flex items-center gap-2 cursor-pointer" onClick={() => updateChar('heroicInspiration', !char.heroicInspiration)}><Dice5 size={24} className={char.heroicInspiration ? "text-amber-400 animate-pulse" : "text-slate-600"} /><div className="flex flex-col"><span className="text-xs text-slate-400 uppercase leading-none">Inspiration</span></div></div>
                            </div>
                        </div>
                    </header>

                    <main className="max-w-6xl mx-auto p-4 grid grid-cols-1 md:grid-cols-12 gap-6 flex-1 w-full">
                        <div className="md:col-span-3 lg:col-span-2 grid grid-cols-3 md:grid-cols-1 gap-4 h-fit">
                            {statsConfig.map(c => {
                                const mod = getModifier(char.stats[c.key]);
                                const isProf = char.saves[c.key];
                                return (
                                    <div key={c.key} className="bg-slate-800 rounded-lg p-3 flex flex-col items-center relative border border-slate-700 shadow-md">
                                        <span className="text-xs text-slate-400 uppercase tracking-widest font-bold mb-1">{c.label}</span>
                                        <div className="flex items-center gap-2">
                                            <button onClick={() => updateChar(`stats.${c.key}`, char.stats[c.key]-1)} className="text-slate-500 hover:text-white">-</button>
                                            <span className="text-2xl font-bold text-white">{char.stats[c.key]}</span>
                                            <button onClick={() => updateChar(`stats.${c.key}`, char.stats[c.key]+1)} className="text-slate-500 hover:text-white">+</button>
                                        </div>
                                        <div className="bg-amber-600 text-white font-bold rounded-full w-10 h-10 flex items-center justify-center -mb-6 border-4 border-slate-900 z-10 shadow-lg">{formatMod(mod)}</div>
                                        <div onClick={()=>{const n={...char.saves}; n[c.key]=!n[c.key]; updateChar('saves',n)}} className={`mt-6 text-xs flex items-center gap-1 cursor-pointer select-none px-2 py-1 rounded ${isProf ? 'bg-indigo-900/50 text-indigo-200' : 'text-slate-500 hover:text-slate-300'}`}>
                                            <Shield size={10} className={isProf ? "fill-current" : ""} /><span>Sv: {formatMod(mod + (isProf?profBonus:0))}</span>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>

                        <div className="md:col-span-5 lg:col-span-6 space-y-6">
                            {/* GRILLE MODIFIÉE : 2 COLONNES SUR MOBILE, 4 SUR BUREAU */}
                            <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <div className="bg-slate-800 border border-slate-700 rounded-xl p-3 flex flex-col items-center justify-center relative"><Shield className="absolute text-slate-700/20 w-16 h-16 -bottom-4 -right-4" /><span className="text-xs text-slate-400 uppercase font-bold">CA</span><input type="number" value={char.ac} onChange={(e) => updateChar('ac', parseInt(e.target.value) || 10)} className="bg-transparent text-3xl font-bold text-white text-center w-full outline-none z-10" /></div>
                                <div className="bg-slate-800 border border-slate-700 rounded-xl p-3 flex flex-col items-center justify-center"><span className="text-xs text-slate-400 uppercase font-bold">Init</span><div className="text-3xl font-bold text-amber-400">{formatMod(getModifier(char.stats.dex) + (char.initiativeBonus || 0))}</div></div>
                                <div className="bg-slate-800 border border-slate-700 rounded-xl p-3 flex flex-col items-center justify-center"><span className="text-xs text-slate-400 uppercase font-bold">Vitesse</span><div className="flex items-baseline"><input type="number" value={char.speed} onChange={(e) => updateChar('speed', parseInt(e.target.value) || 30)} className="bg-transparent text-3xl font-bold text-white text-center w-12 outline-none" /><span className="text-xs text-slate-500">ft</span></div></div>
                                
                                {/* NOUVELLE CASE : PERCEPTION PASSIVE */}
                                <div className="bg-slate-800 border border-slate-700 rounded-xl p-3 flex flex-col items-center justify-center relative overflow-hidden">
                                     <div className="absolute -right-3 -top-3 text-slate-700/20"><Eye size={48} /></div>
                                     <span className="text-xs text-slate-400 uppercase font-bold text-center leading-tight">Perception<br/>Passive</span>
                                     <div className="text-3xl font-bold text-white z-10">{passivePerception}</div>
                                </div>
                            </div>
                            
                            <div className="bg-slate-800 border border-slate-700 rounded-xl p-4 relative overflow-hidden">
                                <div className="flex justify-between items-end mb-2 relative z-10"><label className="text-slate-400 text-sm font-bold uppercase flex items-center gap-2"><Heart className="text-red-500 fill-current" size={16} /> Points de Vie</label><div className="flex items-center gap-1 text-sm text-slate-500">Max: <input type="number" value={char.hp.max} onChange={(e) => updateChar('hp.max', parseInt(e.target.value) || 0)} className="bg-slate-900 text-slate-300 w-12 text-center rounded border border-slate-700 p-0.5" /></div></div>
                                <div className="flex items-center gap-4 relative z-10"><button onClick={() => updateChar('hp.current', char.hp.current - 1)} className="bg-red-900/30 hover:bg-red-900/50 text-red-200 w-10 h-10 rounded-full flex items-center justify-center border border-red-900">-</button><input type="number" value={char.hp.current} onChange={(e) => updateChar('hp.current', parseInt(e.target.value) || 0)} className={`bg-transparent text-5xl font-bold text-center w-full outline-none ${char.hp.current <= (char.hp.max/2) ? 'text-red-400' : 'text-white'}`} /><button onClick={() => updateChar('hp.current', char.hp.current + 1)} className="bg-green-900/30 hover:bg-green-900/50 text-green-200 w-10 h-10 rounded-full flex items-center justify-center border border-green-900">+</button></div>
                                <div className="absolute bottom-0 left-0 h-1 bg-slate-700 w-full"><div className="h-full bg-gradient-to-r from-red-600 to-amber-600 transition-all duration-500" style={{ width: `${Math.min((char.hp.current / char.hp.max) * 100, 100)}%` }}></div></div>
                            </div>

                            <div className="bg-slate-800 border border-slate-700 rounded-xl p-4">
                                <div className="flex justify-between items-center mb-4"><h3 className="font-bold text-slate-300 flex items-center gap-2"><Sword size={18} /> Attaques</h3><button onClick={() => updateChar('attacks', [...char.attacks, { id: Date.now(), name: "Arme", bonus: "+0", damage: "1d6" }])} className="text-xs bg-slate-700 hover:bg-slate-600 text-white px-2 py-1 rounded transition">+ Ajouter</button></div>
                                <div>{char.attacks.map((atk, i) => <AttackRow key={atk.id || i} attack={atk} index={i} updateChar={updateChar} attacksList={char.attacks} moveAttack={(idx, d) => moveItem('attacks', idx, d)} />)}</div>
                                <div className="mt-6 pt-4 border-t border-slate-700">
                                    <div className="flex justify-between items-center mb-2"><h3 className="font-bold text-slate-300 flex items-center gap-2 text-sm uppercase tracking-wider"><Zap size={16} /> Capacités & Traits</h3><button onClick={() => updateChar('features', [...char.features, { id: Date.now(), name: "Nouveau Trait", description: "" }])} className="text-xs bg-amber-600/20 hover:bg-amber-600/40 text-amber-400 px-2 py-1 rounded transition"><Plus size={12} /> Trait</button></div>
                                    <div className="space-y-1">{char.features.map((feat, i) => <FeatureRow key={feat.id || i} feature={feat} index={i} updateChar={updateChar} featuresList={char.features} moveFeature={(idx, d) => moveItem('features', idx, d)} />)}</div>
                                </div>
                            </div>
                        </div>

                        <div className="md:col-span-4 lg:col-span-4 flex flex-col gap-6">
                            <div className="bg-slate-800 border border-slate-700 rounded-xl p-4 flex-none">
                                <h3 className="font-bold text-slate-300 mb-3 flex items-center gap-2 text-sm uppercase tracking-wider"><User size={16} /> Compétences</h3>
                                <div className="space-y-0.5 divide-y divide-slate-700/50">
                                    {skillsList.map(s => {
                                        const p = char.skills[s.key];
                                        const tot = getModifier(char.stats[s.stat]) + (p===true?profBonus:p==='expert'?profBonus*2:0);
                                        return (
                                            <div key={s.key} className="flex items-center justify-between p-2 hover:bg-slate-800 rounded cursor-pointer group" onClick={()=>{const n={...char.skills}; n[s.key]=!p?true:(p===true?'expert':false); updateChar('skills',n)}}>
                                                <div className="flex items-center gap-2"><div className={`w-3 h-3 rounded-full border border-slate-500 ${p?(p==='expert'?'bg-amber-500 border-amber-500':'bg-white border-white'):''}`}></div><span className={`text-sm ${p?'text-white':'text-slate-400'}`}>{s.label}</span></div>
                                                <span className="text-sm font-mono font-bold text-slate-300">{formatMod(tot)}</span>
                                            </div>
                                        )
                                    })}
                                </div>
                            </div>

                            <div className="bg-slate-800 border border-slate-700 rounded-xl p-4 flex-none">
                                <div className="grid grid-cols-4 gap-2">
                                    {['pp','gp','sp','cp'].map(c => <div key={c} className="bg-slate-900/50 rounded p-2 flex flex-col items-center border border-slate-700/50"><label className="text-xs font-bold mb-1 uppercase text-slate-400">{c}</label><input type="number" value={char.coins[c]} onChange={(e)=>updateChar(`coins.${c}`,parseInt(e.target.value)||0)} className="bg-transparent text-center text-white font-mono w-full outline-none" /></div>)}
                                </div>
                            </div>

                            <div className="bg-slate-800 border border-slate-700 rounded-xl p-4">
                                <h3 className="font-bold text-slate-300 mb-2 flex items-center gap-2 text-sm uppercase tracking-wider"><MessageSquare size={16} /> Langues Maîtrisées</h3>
                                <textarea className="w-full bg-slate-900/50 text-slate-300 text-sm p-2 rounded border border-slate-700 focus:border-amber-500/50 outline-none resize-none h-24" value={char.languages} onChange={(e) => updateChar('languages', e.target.value)} placeholder="Langues..." />
                            </div>

                            <div className="bg-slate-800 border border-slate-700 rounded-xl p-4 flex-1">
                                <div className="flex justify-between items-center mb-3"><h3 className="font-bold text-slate-300 flex items-center gap-2 text-sm uppercase tracking-wider"><Backpack size={16} /> Inventaire</h3><button onClick={() => updateChar('inventory', [...char.inventory, { id: Date.now(), name: "Objet", qty: 1 }])} className="text-xs bg-slate-700 hover:bg-slate-600 text-white px-2 py-1 rounded transition">+ Ajouter</button></div>
                                <div className="space-y-1">{char.inventory.map((item, i) => <InventoryRow key={item.id || i} item={item} index={i} updateChar={updateChar} inventoryList={char.inventory} moveInventory={(idx, d) => moveItem('inventory', idx, d)} />)}</div>
                            </div>

                            <div className="bg-slate-800 border border-slate-700 rounded-xl p-4 h-48 flex flex-col">
                                <h3 className="font-bold text-slate-300 mb-2 flex items-center gap-2 text-sm uppercase tracking-wider"><Scroll size={16} /> Autres Notes</h3>
                                <textarea className="flex-1 w-full bg-slate-900/50 text-slate-300 text-sm p-2 rounded border border-slate-700 focus:border-amber-500/50 outline-none resize-none" value={char.notes} onChange={(e) => updateChar('notes', e.target.value)} placeholder="Notes..." />
                            </div>
                        </div>
                    </main>

                    <footer className="bg-slate-900 border-t border-slate-800 p-4 sticky bottom-0 z-50 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.3)]">
                        <div className="max-w-6xl mx-auto flex flex-col sm:flex-row justify-between items-center gap-4 text-xs text-slate-500">
                            <span className="flex items-center gap-2"><div className="w-2 h-2 rounded-full bg-green-500 shadow-[0_0_5px_#22c55e]"></div> Connecté à Firebase (Europe)</span>
                            <div className="flex gap-2">
                                <button onClick={exportData} className="flex items-center gap-1.5 bg-slate-800 hover:bg-slate-700 text-slate-300 px-3 py-1.5 rounded border border-slate-700 transition-colors"><Download size={14} /> Exporter JSON</button>
                                <button onClick={() => importInputRef.current.click()} className="flex items-center gap-1.5 bg-slate-800 hover:bg-slate-700 text-slate-300 px-3 py-1.5 rounded border border-slate-700 transition-colors"><Upload size={14} /> Importer JSON</button>
                                <input type="file" ref={importInputRef} onChange={importData} className="hidden" accept=".json" />
                            </div>
                        </div>
                    </footer>
                </div>
            );
        };

        const App = () => {
            const [profiles, setProfiles] = useState([]);
            const [activeId, setActiveId] = useState(null);
            const [ready, setReady] = useState(false);

            useEffect(() => {
                const init = () => {
                    if (!window.fbDB) return;
                    const indexRef = window.fbRef(window.fbDB, 'dnd_app/index');
                    window.fbOnValue(indexRef, (snapshot) => {
                        const val = snapshot.val();
                        if (val) {
                            setProfiles(val);
                            if (!localStorage.getItem('last_active_id')) setActiveId(val[0].id);
                            else setActiveId(localStorage.getItem('last_active_id'));
                        } else {
                            const newId = 'char-' + Date.now();
                            const initialIndex = [{ id: newId, name: "Nouveau Personnage" }];
                            window.fbSet(indexRef, initialIndex);
                            setProfiles(initialIndex);
                            setActiveId(newId);
                        }
                        setReady(true);
                    });
                };

                if (window.fbDB) init();
                else window.addEventListener('firebase-ready', init);
                return () => window.removeEventListener('firebase-ready', init);
            }, []);

            const handleSwitch = (id) => {
                setActiveId(id);
                localStorage.setItem('last_active_id', id);
            };

            const handleCreate = () => {
                const newId = 'char-' + Date.now();
                const newProfiles = [...profiles, { id: newId, name: "Nouveau Personnage" }];
                window.fbSet(window.fbRef(window.fbDB, 'dnd_app/index'), newProfiles);
                handleSwitch(newId);
            };

            const handleDelete = () => {
                if (profiles.length <= 1) return alert("Gardez au moins un personnage.");
                if (!confirm("Supprimer ce personnage ?")) return;
                
                const newProfiles = profiles.filter(p => p.id !== activeId);
                window.fbRemove(window.fbRef(window.fbDB, `dnd_app/chars/${activeId}`));
                window.fbSet(window.fbRef(window.fbDB, 'dnd_app/index'), newProfiles);
                handleSwitch(newProfiles[0].id);
            };

            const updateProfileName = (id, name) => {
                setProfiles(prevProfiles => {
                    const newIndex = prevProfiles.map(p => p.id === id ? { ...p, name } : p);
                    window.fbSet(window.fbRef(window.fbDB, 'dnd_app/index'), newIndex);
                    return newIndex;
                });
            };

            if (!ready) return <div className="loading-overlay"><div>Chargement du grimoire...</div></div>;

            return (
                <div className="min-h-screen bg-slate-950 text-slate-200 font-sans selection:bg-amber-500/30 flex flex-col">
                    <div className="bg-slate-950 border-b border-slate-800 py-2 px-4 flex flex-col sm:flex-row justify-between items-center gap-3 print:hidden">
                        <div className="flex items-center gap-3 w-full sm:w-auto">
                            <div className="flex items-center gap-2 text-amber-500 font-bold uppercase text-xs tracking-widest"><Users size={16} /> Groupe En Ligne</div>
                            <select value={activeId || ''} onChange={(e) => handleSwitch(e.target.value)} className="bg-slate-900 text-white text-sm border border-slate-700 rounded px-2 py-1 outline-none focus:border-amber-500 flex-1 sm:w-64">
                                {profiles.map(p => <option key={p.id} value={p.id}>{p.name}</option>)}
                            </select>
                        </div>
                        <div className="flex gap-2">
                            <button onClick={handleCreate} className="flex items-center gap-1 bg-emerald-600/20 hover:bg-emerald-600/40 text-emerald-400 text-xs px-3 py-1.5 rounded border border-emerald-600/50 transition"><Plus size={14} /> Nouveau</button>
                            <button onClick={handleDelete} className="flex items-center gap-1 bg-red-600/20 hover:bg-red-600/40 text-red-400 text-xs px-3 py-1.5 rounded border border-red-600/50 transition"><Trash2 size={14} /> Supprimer</button>
                        </div>
                    </div>
                    
                    <ErrorBoundary key={activeId}>
                        <CharacterSheet characterId={activeId} updateProfileName={updateProfileName} />
                    </ErrorBoundary>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
