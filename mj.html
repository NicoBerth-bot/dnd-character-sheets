<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ecran du Maître du Jeu</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { background-color: #0f172a; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        .modal-enter { animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDiLZ6-l8a_rrXUMBYNXPql0TRcN46IAqo",
            authDomain: "dnd-character-sheets-c0bd5.firebaseapp.com",
            databaseURL: "https://dnd-character-sheets-c0bd5-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "dnd-character-sheets-c0bd5",
            storageBucket: "dnd-character-sheets-c0bd5.firebasestorage.app",
            messagingSenderId: "731039801856",
            appId: "1:731039801856:web:9bdb731adfda2d33beeee5"
        };

        // Initialisation stable
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // Adaptateur pour React
        window.fbDB = db;
        window.fbRef = (database, path) => database.ref(path);
        window.fbOnValue = (ref, callback) => {
            const unsub = ref.on('value', callback);
            return () => ref.off('value', unsub);
        };
        window.fbUpdate = (ref, data) => ref.update(data);
        window.fbSet = (ref, data) => ref.set(data);

        console.log("Firebase connecté (Mode Compatibilité)");
        setTimeout(() => window.dispatchEvent(new Event('firebase-ready')), 500);
    </script>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- ICONES CORRIGÉES (Avec les Fragments <></>) ---
        const Icon = ({ p, c }) => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={c}>{p}</svg>;
        const Eye = () => <Icon p={<><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></>} />;
        const Shield = () => <Icon p={<path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>} />;
        const Heart = () => <Icon p={<path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/>} c="text-red-500 fill-current" />;
        const Zap = () => <Icon p={<polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>} />;
        const Ghost = () => <Icon p={<path d="M9 22l3-3 3 3V11a6 6 0 0 0-12 0v11Z"/>} />; 
        const Brain = () => <Icon p={<><path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44 2.5 2.5 0 0 1-2.96-3.08 3 3 0 0 1-.34-5.58 2.5 2.5 0 0 1 1.32-4.24 2.5 2.5 0 0 1 1.98-3A2.5 2.5 0 0 1 9.5 2Z"/><path d="M14.5 2A2.5 2.5 0 0 0 12 4.5v15a2.5 2.5 0 0 0 4.96.44 2.5 2.5 0 0 0 2.96-3.08 3 3 0 0 0 .34-5.58 2.5 2.5 0 0 0-1.32-4.24 2.5 2.5 0 0 0-1.98-3A2.5 2.5 0 0 0 14.5 2Z"/></>} />; 
        
        // ICI : Ajout des fragments <>...</> pour grouper les éléments SVG multiples
        const Compass = () => <Icon p={<><circle cx="12" cy="12" r="10"/><polygon points="16.24 7.76 14.12 14.12 7.76 16.24 9.88 9.88 16.24 7.76"/></>} />;
        const Users = () => <Icon p={<><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></>} />;
        const Check = () => <Icon p={<polyline points="20 6 9 17 4 12"/>} />;
        const X = () => <Icon p={<><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></>} />;

        // --- UTILS ---
        const getModifier = (s) => Math.floor((s - 10) / 2);
        const getProfBonus = (l) => Math.ceil(l / 4) + 1;
        const formatMod = (m) => (m >= 0 ? `+${m}` : m);

        // --- COMPOSANT CARTE JOUEUR ---
        const PlayerCard = ({ id, char, viewMode }) => {
            const prof = getProfBonus(char.level || 1);
            const wisMod = getModifier(char.stats?.wis || 10);
            const dexMod = getModifier(char.stats?.dex || 10);
            
            const percSkill = char.skills?.perception;
            const passivePerc = 10 + wisMod + (percSkill === true ? prof : percSkill === 'expert' ? prof * 2 : 0);
            
            const stealthSkill = char.skills?.stealth;
            const stealthBonus = dexMod + (stealthSkill === true ? prof : stealthSkill === 'expert' ? prof * 2 : 0);
            
            const insightSkill = char.skills?.insight;
            const insightBonus = wisMod + (insightSkill === true ? prof : insightSkill === 'expert' ? prof * 2 : 0);

            const updateHP = (delta) => {
                if (!window.fbDB) return;
                const newCurrent = (char.hp?.current || 0) + delta;
                const updates = {};
                updates[`dnd_app/chars/${id}/hp/current`] = newCurrent;
                window.fbUpdate(window.fbRef(window.fbDB), updates);
            };

            return (
                <div className="bg-slate-800 border border-slate-700 rounded-xl overflow-hidden shadow-lg flex flex-col transition-all hover:border-slate-500">
                    {/* Header */}
                    <div className="bg-slate-900/50 p-3 border-b border-slate-700 flex justify-between items-center">
                        <div className="flex items-center gap-3">
                            <div className="w-10 h-10 rounded-full bg-slate-700 overflow-hidden border border-slate-600">
                                {char.image ? <img src={char.image} className="w-full h-full object-cover" /> : <div className="w-full h-full flex items-center justify-center text-slate-500 font-bold text-xs">{char.name?.[0]}</div>}
                            </div>
                            <div>
                                <h3 className="font-bold text-slate-200 leading-tight">{char.name || "Inconnu"}</h3>
                                <p className="text-xs text-slate-400">{char.class} Niv.{char.level}</p>
                            </div>
                        </div>
                        <div className={`text-sm font-bold ${char.hp?.current < (char.hp?.max/2) ? 'text-red-500 animate-pulse' : 'text-green-500'}`}>
                            {char.hp?.current} / {char.hp?.max} PV
                        </div>
                    </div>

                    {/* VUE COMBAT */}
                    {viewMode === 'combat' && (
                        <div className="p-4 flex-1 flex flex-col gap-4">
                            <div className="grid grid-cols-3 gap-2 text-center">
                                <div className="bg-slate-900/50 rounded p-2 border border-slate-700/50">
                                    <div className="text-xs text-slate-500 uppercase font-bold mb-1">CA</div>
                                    <div className="text-xl font-bold text-white flex justify-center items-center gap-1"><Shield /> {char.ac}</div>
                                </div>
                                <div className="bg-slate-900/50 rounded p-2 border border-slate-700/50">
                                    <div className="text-xs text-slate-500 uppercase font-bold mb-1">Init</div>
                                    <div className="text-xl font-bold text-amber-400">{formatMod(dexMod + (char.initiativeBonus||0))}</div>
                                </div>
                                <div className="bg-slate-900/50 rounded p-2 border border-slate-700/50">
                                    <div className="text-xs text-slate-500 uppercase font-bold mb-1">Vit</div>
                                    <div className="text-xl font-bold text-white">{char.speed}</div>
                                </div>
                            </div>

                            <div className="bg-slate-900/30 rounded p-3 border border-slate-700/50 mt-auto">
                                <div className="flex justify-between items-center mb-2">
                                    <span className="text-xs uppercase font-bold text-slate-400">Gestion PV</span>
                                </div>
                                <div className="flex gap-2 justify-center">
                                    <button onClick={() => updateHP(-5)} className="bg-red-900/40 hover:bg-red-800 text-red-200 text-xs px-2 py-1 rounded border border-red-800">-5</button>
                                    <button onClick={() => updateHP(-1)} className="bg-red-900/40 hover:bg-red-800 text-red-200 text-xs px-2 py-1 rounded border border-red-800">-1</button>
                                    <button onClick={() => updateHP(1)} className="bg-green-900/40 hover:bg-green-800 text-green-200 text-xs px-2 py-1 rounded border border-green-800">+1</button>
                                    <button onClick={() => updateHP(5)} className="bg-green-900/40 hover:bg-green-800 text-green-200 text-xs px-2 py-1 rounded border border-green-800">+5</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* VUE EXPLORATION */}
                    {viewMode === 'exploration' && (
                        <div className="p-4 flex-1 space-y-3">
                            <div className="flex items-center justify-between bg-slate-900/50 p-2 rounded border border-slate-700/50">
                                <div className="flex items-center gap-2 text-slate-300 text-sm"><Eye /> Perception Passive</div>
                                <div className="text-xl font-bold text-white">{passivePerc}</div>
                            </div>
                            <div className="flex items-center justify-between bg-slate-900/50 p-2 rounded border border-slate-700/50">
                                <div className="flex items-center gap-2 text-slate-300 text-sm"><Ghost /> Discrétion</div>
                                <div className="text-lg font-mono font-bold text-amber-400">{formatMod(stealthBonus)}</div>
                            </div>
                            <div className="flex items-center justify-between bg-slate-900/50 p-2 rounded border border-slate-700/50">
                                <div className="flex items-center gap-2 text-slate-300 text-sm"><Brain /> Intuition</div>
                                <div className="text-lg font-mono font-bold text-amber-400">{formatMod(insightBonus)}</div>
                            </div>
                            
                            {/* ALIGNEMENT */}
                            <div className="flex items-center justify-between bg-slate-900/50 p-2 rounded border border-slate-700/50">
                                <div className="flex items-center gap-2 text-slate-300 text-sm"><Compass /> Alignement</div>
                                <div className="text-sm font-bold text-slate-200">{char.alignment || "-"}</div>
                            </div>

                            <div className="mt-2">
                                <div className="text-xs text-slate-500 uppercase font-bold mb-1">Langues</div>
                                <div className="text-xs text-slate-300 italic">{char.languages || "Aucune"}</div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // --- MODALE DE SÉLECTION ---
        const PlayerSelector = ({ allChars, followedIds, toggleFollow, close }) => {
            return (
                <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
                    <div className="bg-slate-900 border border-slate-700 rounded-xl shadow-2xl w-full max-w-md modal-enter flex flex-col max-h-[90vh]">
                        <div className="p-4 border-b border-slate-800 flex justify-between items-center">
                            <h3 className="font-bold text-amber-500 uppercase tracking-wider flex items-center gap-2"><Users /> Sélectionner les Joueurs</h3>
                            <button onClick={close} className="text-slate-500 hover:text-white"><X /></button>
                        </div>
                        <div className="p-4 overflow-y-auto flex-1 space-y-2">
                            {Object.entries(allChars).length === 0 ? (
                                <p className="text-slate-500 text-center italic">Aucune fiche trouvée dans la base.</p>
                            ) : (
                                Object.entries(allChars).map(([id, char]) => {
                                    const isSelected = followedIds.includes(id);
                                    return (
                                        <div 
                                            key={id} 
                                            onClick={() => toggleFollow(id)}
                                            className={`flex items-center justify-between p-3 rounded-lg border cursor-pointer transition ${isSelected ? 'bg-indigo-900/30 border-indigo-500' : 'bg-slate-800 border-slate-700 hover:bg-slate-700'}`}
                                        >
                                            <div className="flex items-center gap-3">
                                                <div className={`w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold border ${isSelected ? 'border-indigo-400 bg-indigo-900 text-white' : 'border-slate-600 bg-slate-700 text-slate-400'}`}>
                                                    {char.name?.[0]}
                                                </div>
                                                <div>
                                                    <div className={`font-bold ${isSelected ? 'text-white' : 'text-slate-400'}`}>{char.name}</div>
                                                    <div className="text-xs text-slate-500">{char.class} Niv.{char.level}</div>
                                                </div>
                                            </div>
                                            {isSelected && <div className="text-indigo-400"><Check /></div>}
                                        </div>
                                    )
                                })
                            )}
                        </div>
                        <div className="p-4 border-t border-slate-800 bg-slate-900/50 rounded-b-xl flex justify-end">
                            <button onClick={close} className="bg-amber-600 hover:bg-amber-500 text-white px-4 py-2 rounded font-bold text-sm">Valider</button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- APP PRINCIPALE MJ ---
        const DMApp = () => {
            const [allChars, setAllChars] = useState({});
            const [followedIds, setFollowedIds] = useState([]);
            const [viewMode, setViewMode] = useState('combat');
            const [ready, setReady] = useState(false);
            const [showSelector, setShowSelector] = useState(false);

            useEffect(() => {
                const init = () => {
                    if (!window.fbDB) return;
                    
                    const savedIds = localStorage.getItem('dm_followed_ids');
                    if (savedIds) {
                        try { setFollowedIds(JSON.parse(savedIds)); } catch(e) {}
                    }

                    const charsRef = window.fbRef(window.fbDB, 'dnd_app/chars');
                    window.fbOnValue(charsRef, (snapshot) => {
                        const data = snapshot.val();
                        setAllChars(data || {});
                        setReady(true);
                    });
                };

                if (window.fbDB) init();
                else window.addEventListener('firebase-ready', init);
                return () => window.removeEventListener('firebase-ready', init);
            }, []);

            const toggleFollow = (id) => {
                setFollowedIds(prev => {
                    const next = prev.includes(id) 
                        ? prev.filter(x => x !== id) 
                        : [...prev, id];
                    localStorage.setItem('dm_followed_ids', JSON.stringify(next));
                    return next;
                });
            };

            if (!ready) return <div className="h-screen flex items-center justify-center text-slate-500 animate-pulse">Initialisation MJ...</div>;

            const visibleChars = followedIds
                .filter(id => allChars[id])
                .map(id => ({ id, ...allChars[id] }));

            return (
                <div className="min-h-screen p-4 md:p-8">
                    {/* TOP BAR */}
                    <div className="max-w-7xl mx-auto flex flex-col sm:flex-row justify-between items-center mb-8 gap-4">
                        <div className="flex items-center gap-4">
                            <h1 className="text-2xl font-bold text-amber-500 tracking-wider uppercase border-b-2 border-amber-500/50 pb-1">Maître du Jeu</h1>
                            <button 
                                onClick={() => setShowSelector(true)}
                                className="flex items-center gap-2 bg-slate-800 hover:bg-slate-700 text-slate-300 px-3 py-1.5 rounded border border-slate-700 text-sm font-bold transition"
                            >
                                <Users /> Gérer les joueurs ({visibleChars.length})
                            </button>
                        </div>
                        
                        <div className="bg-slate-800 p-1 rounded-lg flex gap-1 border border-slate-700">
                            <button onClick={() => setViewMode('combat')} className={`flex items-center gap-2 px-4 py-1.5 rounded text-sm font-bold transition ${viewMode === 'combat' ? 'bg-red-900/80 text-white shadow' : 'text-slate-400 hover:text-white'}`}><Zap /> Combat</button>
                            <button onClick={() => setViewMode('exploration')} className={`flex items-center gap-2 px-4 py-1.5 rounded text-sm font-bold transition ${viewMode === 'exploration' ? 'bg-indigo-900/80 text-white shadow' : 'text-slate-400 hover:text-white'}`}><Eye /> Exploration</button>
                        </div>
                    </div>

                    {/* MODALE SELECTEUR */}
                    {showSelector && (
                        <PlayerSelector 
                            allChars={allChars} 
                            followedIds={followedIds} 
                            toggleFollow={toggleFollow} 
                            close={() => setShowSelector(false)} 
                        />
                    )}

                    {/* GRID DES JOUEURS */}
                    <div className="max-w-7xl mx-auto grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                        {visibleChars.length === 0 ? (
                            <div className="col-span-full text-center py-20 bg-slate-800/50 rounded-xl border border-dashed border-slate-700 flex flex-col items-center justify-center gap-4">
                                <p className="text-slate-500 text-lg">Aucun personnage suivi.</p>
                                <button onClick={() => setShowSelector(true)} className="bg-amber-600 hover:bg-amber-500 text-white px-6 py-3 rounded-lg font-bold shadow-lg flex items-center gap-2 animate-bounce"><Users /> Sélectionner les joueurs présents</button>
                            </div>
                        ) : (
                            visibleChars.map(char => (
                                <PlayerCard key={char.id} id={char.id} char={char} viewMode={viewMode} />
                            ))
                        )}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<DMApp />);
    </script>
</body>
</html>